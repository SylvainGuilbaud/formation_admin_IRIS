services:
  iris-training:
    build: 
      args:
        IMAGE: ${IMAGE_IRIS_DEV_PREVIEW}
      context: iris-training
    image: iris-training  
    restart: always
    hostname: iris-training
    container_name: iris-training
    environment:
      - TZ=$TZ
      - ISC_DATA_DIRECTORY=/databases
      - ISC_CPF_MERGE_FILE=/merge.cpf
    ports: 
      - 11972:1972
      - 10000:52773
    volumes:
      - ./iris-training:/irisdev/app
      - ./jdbc:/jdbc
      - databases_training:/databases
      - journal_training:/journal
      - journal2_training:/journal2
      - WIJ_training:/WIJ
      - ./merge.cpf:/merge.cpf

  iris-prod-1:
    build: 
      args:
        IMAGE: ${IMAGE_IRIS_PROD_PREVIEW}
      context: iris-prod
    image: iris-prod-1
    restart: always
    init: true
    container_name: iris-prod-1
    hostname: iris-prod-1
    volumes:
    - ./iris-prod:/irisdev/app
    - ./jdbc:/jdbc
    - databases_prod_1:/databases
    - journal_prod_1:/journal
    - journal2_prod_1:/journal2
    - WIJ_prod_1:/WIJ
    - ./merge.cpf:/merge.cpf
    - type: bind
      source: ./iris-prod
      target: /iris-prod-1
    - type: bind
      source: ./webgateway/cert
      target: /opt/cert
    - type: bind
      source: ./mirror/mirror-certs
      target: /mirror-certs
    environment:
      - TZ=$TZ
      - ISC_DATA_DIRECTORY=/databases
      - ISC_CPF_MERGE_FILE=/merge.cpf
    ports:
      - 10001:1972
    command: --key /iris-prod-1/key/iris.key -a /iris-prod-1/configure.sh
  
  iris-prod-2:
    build: 
      args:
        IMAGE: ${IMAGE_IRIS_PROD_PREVIEW}
      context: iris-prod
    image: iris-prod-2
    restart: always
    init: true
    container_name: iris-prod-2
    hostname: iris-prod-2
    volumes:
    - ./iris-prod:/irisdev/app
    - ./jdbc:/jdbc
    - databases_prod_2:/databases
    - journal_prod_2:/journal
    - journal2_prod_2:/journal2
    - WIJ_prod_2:/WIJ
    - ./merge.cpf:/merge.cpf
    - type: bind
      source: ./iris-prod
      target: /iris-prod-2
    - type: bind
      source: ./webgateway/cert
      target: /opt/cert
    - type: bind
      source: ./mirror/mirror-certs
      target: /mirror-certs
    environment:
      - TZ=$TZ
      - ISC_DATA_DIRECTORY=/databases
      - ISC_CPF_MERGE_FILE=/merge.cpf
    ports:
      - 10002:1972
    command: --key /iris-prod-2/key/iris.key -a /iris-prod-2/configure.sh

  webgateway:
    image: ${WEBGATEWAY}
    init: true
    hostname: ${WEBGATEWAY_NAME}
    container_name: ${WEBGATEWAY_NAME}
    ports:
    - ${WEBGATEWAY_PORT_HTTP}:80
    - ${WEBGATEWAY_PORT_HTTPS}:443
    environment:
    - ISC_CSP_CONF_FILE=/webgateway/CSP.conf
    - ISC_CSP_INI_FILE=/webgateway/CSP.ini
    volumes:
    - type: bind
      source: ./webgateway
      target: /webgateway
    - type: bind
      source: ./webgateway/cert
      target: /opt/cert
  arbiter:
    image: ${ARBITER}
    container_name: ${ARBITER_NAME}
    hostname: ${ARBITER_NAME}
    # command: ["-p 2188"]

  notebook:
    image: notebook
    container_name: notebook
    build: 
      context: notebook
    ports:
      - "8889:8888"
    volumes:
      - ./notebook/Notebooks:/Notebooks
    command: "start-notebook.sh --NotebookApp.token='' --NotebookApp.password='' --notebook-dir=/Notebooks"

  # postgres:
  #   container_name: training-postgres
  #   image: postgres:latest
  #   environment:
  #     POSTGRES_PASSWORD: postgres
  #   volumes:
  #     - ./postgreSQL:/docker-entrypoint-initdb.d/
  #     - ./databases/postgreSQL:/var/lib/postgresql/data
  #   ports:
  #     - 52004:5432
  #   restart: unless-stopped
  #   healthcheck:
  #       test: ["CMD", "pg_isready", "-U", "postgres"]
  #       interval: 30s
  #       timeout: 30s
  #       retries: 3

volumes:
  databases_training:
    external: true
    name: formation_admin_iris-2_databases_training
  journal_training:
    external: true
    name: formation_admin_iris-2_journal_training
  journal2_training:
    external: true
    name: formation_admin_iris-2_journal2_training
  WIJ_training:
    external: true
    name: formation_admin_iris-2_WIJ_training
  databases_prod_1:
    external: true
    name: formation_admin_iris-2_databases_prod_1
  journal_prod_1:
    external: true
    name: formation_admin_iris-2_journal_prod_1
  journal2_prod_1:
    external: true
    name: formation_admin_iris-2_journal2_prod_1
  WIJ_prod_1:
    external: true
    name: formation_admin_iris-2_WIJ_prod_1
  databases_prod_2:
    external: true
    name: formation_admin_iris-2_databases_prod_2
  journal_prod_2:
    external: true
    name: formation_admin_iris-2_journal_prod_2
  journal2_prod_2:
    external: true
    name: formation_admin_iris-2_journal2_prod_2
  WIJ_prod_2: 
    external: true
    name: formation_admin_iris-2_WIJ_prod_2
